# Feature Request: TypedDict Code Generation

**Priority:** MEDIUM
**Type:** Feature
**Status:** Proposed
**Effort:** 1 day
**Requested:** 2026-01-28

## Summary

Add a CLI command to export the dynamically-built TypedDict state class to a Python file for IDE support and static type checking.

## Problem

YamlGraph dynamically generates `TypedDict` state classes at runtime from `state:` declarations in graph YAML (`state_builder.py`). This works perfectly for execution, but:

1. **No IDE autocomplete** - When writing Python handlers, `state: dict` provides no hints
2. **No static type checking** - mypy/pyright can't validate handler code against state schema
3. **Runtime errors instead of compile-time** - Typos like `state["extrcted"]` aren't caught until execution

Applications like `questionnaire-api` have 495-line handler files (`graph_handlers.py`) where type safety would prevent bugs.

## Proposed Solution

### CLI Command

```bash
# Generate TypedDict for a single graph
yamlgraph codegen graphs/interview.yaml --output src/types/interview_state.py

# Generate for multiple graphs
yamlgraph codegen graphs/*.yaml --output-dir src/types/

# Preview without writing (dry-run)
yamlgraph codegen graphs/interview.yaml --dry-run
```

### Generated Output

```python
# Auto-generated by yamlgraph codegen from graphs/interview.yaml
# Do not edit manually - regenerate with: yamlgraph codegen graphs/interview.yaml
from typing import TypedDict, Any

class InterviewState(TypedDict, total=False):
    """State for interview graph."""

    # Input
    user_message: str
    template_name: str

    # Conversation
    messages: list

    # Extraction
    extracted: dict
    gaps: list
    has_gaps: bool

    # Output
    response: str
    phase: str
    complete: bool
```

### Usage in Handlers

```python
# src/questionnaire/graph_handlers.py
from types.interview_state import InterviewState

def detect_gaps(state: InterviewState) -> dict:
    # IDE now provides autocomplete for state keys
    extracted = state["extracted"]  # ✅ Autocomplete
    template = state["template"]    # ✅ Type hints
    state["extrcted"]               # ❌ IDE warning: key not in TypedDict

    return {"gaps": gaps, "has_gaps": len(gaps) > 0}
```

### Implementation

Extend existing `state_builder.py`:

```python
# yamlgraph/models/state_builder.py

def export_state_class(config: GraphConfig, output_path: Path) -> None:
    """Export state TypedDict to Python file."""
    fields = _collect_state_fields(config)

    lines = [
        f"# Auto-generated by yamlgraph codegen from {config.source_path}",
        f"# Do not edit manually",
        "from typing import TypedDict, Any",
        "",
        f"class {_class_name(config.name)}State(TypedDict, total=False):",
        f'    """State for {config.name} graph."""',
    ]

    for name, type_hint in fields.items():
        lines.append(f"    {name}: {type_hint}")

    output_path.write_text("\n".join(lines))
```

## Acceptance Criteria

- [ ] `yamlgraph codegen <graph> --output <path>` writes TypedDict file
- [ ] `--dry-run` flag previews output without writing
- [ ] `--output-dir` handles multiple graphs with auto-naming
- [ ] Generated file includes source graph path in header comment
- [ ] Type hints preserve original YAML types (str, list, dict, bool, int, float)
- [ ] Complex types (list[str], dict[str, Any]) correctly formatted
- [ ] Works with graphs using `state:` section
- [ ] Infers types from `state_key` when `state:` section absent
- [ ] Tests added for codegen module
- [ ] Documentation in reference/cli.md

## Alternatives Considered

### 1. Runtime Type Injection (Rejected)
Dynamically inject types into handler modules at import time. Too magical, breaks IDE analysis.

### 2. Stub Files (.pyi) (Possible Enhancement)
Generate `.pyi` stub files instead of full Python. Could be added later as `--stub` flag.

### 3. Pydantic Models Instead of TypedDict (Rejected)
Heavier, LangGraph uses TypedDict pattern, stay consistent.

## Related

- `yamlgraph/models/state_builder.py` - Existing dynamic TypedDict generation
- `yamlgraph/models/graph_schema.py` - Pydantic schema for validation
- questionnaire-api `src/questionnaire/graph_handlers.py` - Consumer that would benefit
